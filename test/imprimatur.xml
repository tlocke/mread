<?xml version="1.0"?>
<!DOCTYPE imprimatur PUBLIC 
    "-//Imprimatur DTD 009//EN"
    "http://imprimatur.sourceforge.net/imprimatur-009.dtd">
<imprimatur port="8080" hostname="localhost">
  <test name="Look at home page">
    <request path="/">
      <response-code value="200" />
    </request>
  </test>

  <test name="Try logging in.">
    <!-- Log in-->
    <request path="/xhr/sign_in" method="post">
      <control name="assert" value="assrt"/>
      <control name="user_email" value="test@example.com"/>
      <response-code value="200" />
    </request>

    <!-- Create account -->
    <request path="/add_reader" method="post">
      <control name="name" value="Test"/>
      <response-code value="303" />
    </request>
    <request path="/">
      <response-code value="200" />
      <regex pattern="Account created successfully." />
    </request>

    <!-- Add a meter -->
    <request path="/add_meter" method="post">
      <refresh/>
      <control name="utility_units" value="electricity-kWh" />
      <control name="name" value="House" />
      <control name="time_zone" value="UTC" />
      <control name="email_address" value="None" />
      <control name="confirm_email_address" value="None" />
      <control name="reminder_frequency" value="never" />
      <control name="reminder_start_year" value="2011" />
      <control name="reminder_start_month" value="05" />
      <control name="reminder_start_day" value="01" />
      <control name="reminder_start_hour" value="18" />
      <control name="reminder_start_minute" value="30" />
      <control name="customer_read_frequency" value="monthly" />
      <response-code value="303" />
    </request>
  </test>
  <test name="View the meter.">
    <request path="/view_meter?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww">
      <regex pattern='&lt;a id="signout" href="javascript:void\(0\)"&gt;Sign Out&lt;/a&gt;'/>

      <regex pattern='&gt;Test&lt;' />

      <response-code value="200" />
    </request>
  </test>
  <test name="View meter settings.">
    <request
      path="/meter_settings?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww">
      <regex pattern='&gt;Test&lt;' />
      <regex
        pattern='&lt;option value="electricity-kWh" selected&gt;Electricity - kWh&lt;/option&gt;' />
      <response-code value="200" />
    </request>
  </test>
  <test name="Insert a read.">
    <request path="/view_meter" method="post">
      <control name="meter_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww" />
      <control name="read_year" value="2011" />
      <control name="read_month" value="02" />
      <control name="read_day" value="13" />
      <control name="read_hour" value="17" />
      <control name="read_minute" value="48" />
      <control name="value" value="41" />
      <response-code value="200" />
    </request>
  </test>
  <test name="View the read.">
    <request path="/view_read?read_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchELEgRSZWFkGICAgICAgMAIDA">
      <response-code value="200" />
    </request>
  </test>
  <test name="View the edit_read page.">
    <request path="/edit_read?read_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchELEgRSZWFkGICAgICAgMAIDA">
      <response-code value="200" />
      <regex
        pattern='&lt;legend&gt;Delete This Read&lt;/legend&gt;\s*&lt;input type="hidden" name="read_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchELEgRSZWFkGICAgICAgMAIDA"' />
    </request>
  </test>
  <test name="Insert a read with a blank value.">
    <request path="/view_meter" method="post">
      <control name="meter_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww" />
      <control name="read_year" value="2011" />
      <control name="read_month" value="02" />
      <control name="read_day" value="13" />
      <control name="read_hour" value="18" />
      <control name="read_minute" value="48" />
      <control name="value" value="" />
      <response-code value="400" />
      <regex pattern="The 'value' field doesn't seem to be a number\." />
    </request>
  </test>
  <test name="Try inserting a read that's not a number.">
    <request path="/view_meter" method="post">
      <control name="meter_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww" />
      <control name="read_year" value="2011" />
      <control name="read_month" value="02" />
      <control name="read_day" value="13" />
      <control name="read_hour" value="18" />
      <control name="read_minute" value="48" />
      <control name="value" value="sportive bombination" />
      <response-code value="400" />
      <regex pattern="The 'value' field doesn't seem to be a number\." />
    </request>
  </test>
  <test name="Delete a read.">
    <request path="/edit_read" method="post">
      <control name="read_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchELEgRSZWFkGICAgICAgMAIDA" />
      <control name="delete" value="Delete" />
      <response-code value="303" />
    </request>
  </test>
  <test name="Insert another read.">
    <request path="/view_meter" method="post">
      <control name="meter_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww" />
      <control name="read_year" value="2011" />
      <control name="read_month" value="02" />
      <control name="read_day" value="15" />
      <control name="read_hour" value="18" />
      <control name="read_minute" value="40" />
      <control name="value" value="49" />
      <response-code value="200" />
    </request>
  </test>
  <test name="Have a look at the upload page.">
    <request path="/upload?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww">
      <regex pattern='"/view_meter\?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww"' />
      <response-code value="200" />
    </request>
  </test>
  <test name="Have a look at the chart page.">
    <request path="/chart?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww">
      <regex pattern='Sign Out' />
      <response-code value="200" />
    </request>
  </test>
  <test name="Have a look at the reader.">
    <request path="/view_reader?reader_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgZSZWFkZXIYgICAgICAgAkM">
      <regex pattern='Sign Out' />
      <response-code value="200" />
    </request>
  </test>
  <test name="Propose an email.">
    <request path="/reader_settings" method="post">
      <control name="reader_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgZSZWFkZXIYgICAgICAgAkM" />
      <control name="proposed_email" value="pink@example.com" />
      <control name="propose_email" value="Propose Email" />
      <response-code value="200" />
    </request>
  </test>
  <test name="Try admin stuff.">

    <!-- Sign out -->

    <request
      path="/_ah/login?continue=http%3A//localhost%3A8080/&amp;action=Logout"
      follow-redirects="true">
      <response-code value="200" />
    </request>

    <!-- Sign in as administrator -->
    <request
      path="/_ah/login?email=admin@example.com&amp;admin=True&amp;continue=http://localhost:8080/&amp;action=Login"
      follow-redirects="true">
      <response-code value="200" />
    </request>

    <!-- Try sending the reminders -->
    <request path="/cron/reminders">
      <response-code value="200" />
    </request>

    <!-- And Sign out the administrator -->
    <request
      path="/_ah/login?continue=http%3A//localhost%3A8080/&amp;action=Logout"
      follow-redirects="true">
      <response-code value="200" />
    </request>
  </test>
  <test name="Try and view the meter without being signed in">
    <request path="/xhr/sign_out">
    </request>
    <request path="/view_meter?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww">
      <response-code value="401" />
    </request>
  </test>
  <test
    name="Log in, change the meter to public and check it's there on the homepage.">
    <request path="/xhr/sign_in" method="post">
      <control name="assert" value="assrt"/>
      <control name="user_email" value="test@example.com"/>
      <response-code value="200" />
    </request>

    <!-- Also change utility to gas, and reminder frequency to 'monthly' -->
    <request path="/meter_settings" method="post">
      <control name="meter_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww" />
      <control name="utility_units" value="gas-m3" />
      <control name="name" value="House" />
      <control name="time_zone" value="UTC" />
      <control name="email_address" value="None" />
      <control name="confirm_email_address" value="None" />
      <control name="reminder_frequency" value="monthly" />
      <control name="reminder_start_year" value="2011" />
      <control name="reminder_start_month" value="05" />
      <control name="reminder_start_day" value="01" />
      <control name="reminder_start_hour" value="18" />
      <control name="reminder_start_minute" value="30" />
      <control name="is_public" value="True" />
      <control name="customer_read_frequency" value="monthly" />
      <response-code value="200" />
    </request>

    <request path="/xhr/sign_out">
      <response-code value="200" />
    </request>

    <!-- Check the details of the public meter is shown -->
    <request path="/">
      <regex
        pattern='&lt;tr&gt;\s*&lt;td&gt;Test&lt;/td&gt;\s*&lt;td&gt;\s*&lt;a href="/view_meter\?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww"&gt;House&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;Gas&lt;/td&gt;\s*&lt;td&gt;2011-02-15 18:40&lt;/td&gt;\s*&lt;td&gt;\s*&lt;a href="/view_read\?read_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchELEgRSZWFkGICAgICAgMAKDA"&gt;49\.0&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;m&lt;sup&gt;3&lt;/sup&gt;\s*&lt;/td&gt;' />
    </request>

    <request path="/view_read?read_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchELEgRSZWFkGICAgICAgMAKDA">
      <response-code value="200" />
    </request>
  </test>
  <test name="Log in with proposed email">
    <request path="/xhr/sign_in" method="post">
      <control name="assert" value="assrt"/>
      <control name="user_email" value="pink@example.com"/>
      <response-code value="200" />
    </request>

    <request path="/welcome">
      <regex pattern='pink@example.com' />
      <response-code value="200" />
    </request>

    <request path="/welcome" method="post">
      <control name="reader_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgZSZWFkZXIYgICAgICAgAkM" />
      <control name="associate" value="Associate" />
      <response-code value="303" />
    </request>

    <!-- Check that 'gas' is still displayed -->
    <request
      path="/meter_settings?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww">
      <refresh/>
      <regex
        pattern='&lt;option value="gas-m3" selected&gt;Gas - m&amp;sup3;&lt;/option&gt;' />
      <response-code value="200" />
    </request>
  </test>
  <test name="Try editing a read">
    <request path="/edit_read" method="post">
      <control name="read_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchELEgRSZWFkGICAgICAgMAKDA" />
      <control name="read_year" value="2011" />
      <control name="read_month" value="07" />
      <control name="read_day" value="21" />
      <control name="read_hour" value="18" />
      <control name="read_minute" value="40" />
      <control name="value" value="49.0" />
      <response-code value="200" />
    </request>
  </test>
  <test name="Send a customer read">
    <!-- Set header data -->
    <request path="/send_read" method="post">
      <control name="read_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchELEgRSZWFkGICAgICAgMAKDA" />
      <control name="send_read_to" value="supplier@example.com" />
      <control name="send_read_name" value="Sun Tzu" />
      <control name="send_read_reader_email" value="stzu@example.com" />
      <control name="send_read_address" value="21b Baker Street" />
      <control name="send_read_postcode" value="78560992" />
      <control name="send_read_account" value="89u5u809" />
      <control name="send_read_msn" value="sdjii388" />
      <control name="update" value="Update" />
      <response-code value="200" />
    </request>

    <request path="/send_read" method="post">
      <control name="read_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchELEgRSZWFkGICAgICAgMAKDA" />
      <control name="send" value="Send" />
      <response-code value="200" />
    </request>

    <request path="/view_meter?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgVNZXRlchiAgICAgICACww">
      <regex pattern="&lt;th&gt;Date of last customer read&lt;/th&gt;"/>
      <regex pattern="&lt;td&gt;\s*2011-07-21 18:40\s*&lt;/td&gt;"/>
      <response-code value="200" />
    </request>
  </test>
</imprimatur>
