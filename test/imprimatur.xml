<?xml version="1.0"?>
<!DOCTYPE imprimatur PUBLIC 
    "-//Imprimatur DTD 009//EN"
    "http://imprimatur.sourceforge.net/imprimatur-009.dtd">
<imprimatur port="8080" hostname="localhost">
  <test name="Look at home page">
    <request path="/">
      <response-code value="200" />
    </request>
  </test>

  <test name="Try logging in.">
    <!-- Look at log in page -->
    <request path="/sign_in">
      <response-code value="200" />
    </request>

    <!-- Sign in -->
    <request
      path="/_ah/login?email=test%40example.com&amp;action=Login&amp;continue=http%3A%2F%2Flocalhost%3A8080%2Fwelcome"
      follow-redirects="true">
      <response-code value="200" />
    </request>

    <!-- Create account -->
    <request path="/welcome" method="post">
      <response-code value="303" />
      <regex pattern="/" />
    </request>

    <request path="/">
      <response-code value="200" />
      <regex pattern="Account created successfully\." />
    </request>

    <!-- Add a meter -->
    <request path="/add_meter" method="post">
      <refresh/>
      <control name="utility_units" value="electricity-kWh" />
      <control name="name" value="House" />
      <control name="time_zone" value="UTC" />
      <control name="email_address" value="None" />
      <control name="confirm_email_address" value="None" />
      <control name="reminder_frequency" value="never" />
      <control name="reminder_start_year" value="2011" />
      <control name="reminder_start_month" value="05" />
      <control name="reminder_start_day" value="01" />
      <control name="reminder_start_hour" value="18" />
      <control name="reminder_start_minute" value="30" />
      <control name="customer_read_frequency" value="monthly" />
      <response-code value="200" />
    </request>
  </test>
  <test name="View the meter.">
    <request path="/view_meter?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM">
      <regex
        pattern='&lt;a href="/_ah/login\?continue=http%3A//localhost%3A8080/&amp;action=logout"&gt;Sign Out&lt;/a&gt;' />
      <regex pattern='&gt;test@example.com&lt;' />

      <response-code value="200" />
    </request>
  </test>
  <test name="View meter settings.">
    <request
      path="/meter_settings?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM">
      <regex pattern='&gt;test@example.com&lt;' />
      <regex
        pattern='&lt;option value="electricity-kWh" selected&gt;Electricity - kWh&lt;/option&gt;' />
      <response-code value="200" />
    </request>
  </test>
  <test name="Insert a read.">
    <request path="/view_meter" method="post">
      <control name="meter_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM" />
      <control name="read_year" value="2011" />
      <control name="read_month" value="02" />
      <control name="read_day" value="13" />
      <control name="read_hour" value="17" />
      <control name="read_minute" value="48" />
      <control name="value" value="41" />
      <response-code value="200" />
    </request>
  </test>
  <test name="View the read.">
    <request path="/view_read?read_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgRSZWFkGICAgICAgICARAw">
      <response-code value="200" />
    </request>
  </test>
  <test name="View the edit_read page.">
    <request path="/edit_read?read_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgRSZWFkGICAgICAgICARAw">
      <response-code value="200" />
      <regex
        pattern='&lt;legend&gt;Delete This Read&lt;/legend&gt;[\r\n] *&lt;input type="hidden" name="read_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgRSZWFkGICAgICAgICARAw"' />
    </request>
  </test>
  <test name="Insert a read with a blank value.">
    <request path="/view_meter" method="post">
      <control name="meter_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM" />
      <control name="read_year" value="2011" />
      <control name="read_month" value="02" />
      <control name="read_day" value="13" />
      <control name="read_hour" value="18" />
      <control name="read_minute" value="48" />
      <control name="value" value="" />
      <response-code value="400" />
      <regex pattern="The 'value' field doesn't seem to be a number\." />
    </request>
  </test>
  <test name="Try inserting a read that's not a number.">
    <request path="/view_meter" method="post">
      <control name="meter_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM" />
      <control name="read_year" value="2011" />
      <control name="read_month" value="02" />
      <control name="read_day" value="13" />
      <control name="read_hour" value="18" />
      <control name="read_minute" value="48" />
      <control name="value" value="sportive bombination" />
      <response-code value="400" />
      <regex pattern="The 'value' field doesn't seem to be a number\." />
    </request>
  </test>
  <test name="Delete a read.">
    <request path="/edit_read" method="post">
      <control name="read_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchILEgRSZWFkGICAgICAgICARAw" />
      <control name="delete" value="Delete" />
      <response-code value="303" />
    </request>
  </test>
  <test name="Insert another read.">
    <request path="/view_meter" method="post">
      <control name="meter_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM" />
      <control name="read_year" value="2011" />
      <control name="read_month" value="02" />
      <control name="read_day" value="15" />
      <control name="read_hour" value="18" />
      <control name="read_minute" value="40" />
      <control name="value" value="49" />
      <response-code value="200" />
    </request>
  </test>
  <test name="Have a look at the upload page.">
    <request path="/upload?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM">
      <regex pattern='"/view_meter\?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM"' />
      <response-code value="200" />
    </request>
  </test>
  <test name="Have a look at the chart page.">
    <request path="/chart?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM">
      <regex pattern='Sign Out' />
      <response-code value="200" />
    </request>
  </test>
  <test name="Have a look at the reader.">
    <request path="/view_reader?reader_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchQLEgZSZWFkZXIYgICAgICAgIBIDA">
      <regex pattern='Sign Out' />
      <response-code value="200" />
    </request>
  </test>
  <test name="Propose an OpenId.">
    <request path="/reader_settings" method="post">
      <control name="reader_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchQLEgZSZWFkZXIYgICAgICAgIBIDA" />
      <control name="proposed_openid" value="pink@example.com" />
      <control name="propose_openid" value="Propose OpenId" />
      <response-code value="200" />
    </request>
  </test>
  <test name="Try admin stuff.">

    <!-- Sign out -->

    <request
      path="/_ah/login?continue=http%3A//localhost%3A8080/&amp;action=Logout"
      follow-redirects="true">
      <response-code value="200" />
    </request>

    <!-- Sign in as administrator -->
    <request
      path="/_ah/login?email=admin@example.com&amp;admin=True&amp;continue=http://localhost:8080/&amp;action=Login"
      follow-redirects="true">
      <response-code value="200" />
    </request>

    <!-- Try sending the reminders -->
    <request path="/cron/reminders">
      <response-code value="200" />
    </request>

    <!-- And Sign out -->
    <request
      path="/_ah/login?continue=http%3A//localhost%3A8080/&amp;action=Logout"
      follow-redirects="true">
      <response-code value="200" />
    </request>
  </test>
  <test name="Try and view the meter without being signed in">
    <request path="/view_meter?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM">
      <response-code value="401" />
    </request>
  </test>
  <test
    name="Log in, change the meter to public and check it's there on the homepage.">
    <request
      path="/_ah/login?email=test@example.com&amp;continue=http://localhost:8080/&amp;action=Login"
      follow-redirects="true">
      <response-code value="200" />
    </request>
    <!-- Also change utility to gas -->
    <request path="/meter_settings" method="post">
      <control name="meter_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM" />
      <control name="utility_units" value="gas-m3" />
      <control name="name" value="House" />
      <control name="time_zone" value="UTC" />
      <control name="email_address" value="None" />
      <control name="confirm_email_address" value="None" />
      <control name="reminder_frequency" value="never" />
      <control name="reminder_start_year" value="2011" />
      <control name="reminder_start_month" value="05" />
      <control name="reminder_start_day" value="01" />
      <control name="reminder_start_hour" value="18" />
      <control name="reminder_start_minute" value="30" />
      <control name="is_public" value="True" />
      <control name="customer_read_frequency" value="monthly" />
      <response-code value="200" />
    </request>

    <!-- Sign out -->
    <request
      path="/_ah/login?continue=http%3A//localhost%3A8080/&amp;action=Logout"
      follow-redirects="true">
      <response-code value="200" />
    </request>

    <!-- Check the details of the public meter is shown -->
    <request path="/">
      <regex
        pattern='&lt;tr&gt;[\r\n]&lt;td&gt;Me&lt;/td&gt;&lt;td&gt;&lt;a href="/meter\?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM"&gt;House&lt;/a&gt;&lt;/td&gt;&lt;td&gt;Gas&lt;/td&gt;&lt;td&gt;2011-02-15 18:40&lt;/td&gt;&lt;td&gt;&lt;a href="/read\?read_key=ahBkZXZ-bWV0ZXJlYWQtaHJkcgoLEgRSZWFkGAQM"&gt;49.0&lt;/a&gt;&lt;/td&gt;&lt;td&gt;m&lt;sup&gt;3&lt;/sup&gt;&lt;/td&gt;' />
    </request>

    <request path="/read?read_key=ahBkZXZ-bWV0ZXJlYWQtaHJkcgoLEgRSZWFkGAQM">
      <response-code value="200" />
    </request>
  </test>
  <test name="Log in with proposed OpenId">
    <request
      path="/_ah/login?email=pink@example.com&amp;continue=http://localhost:8080/welcome&amp;action=Login"
      follow-redirects="true">
      <response-code value="200" />
      <regex
        pattern='&lt;input type="hidden" name="reader_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchQLEgZSZWFkZXIYgICAgICAgIBIDA"&gt;' />
    </request>

    <request path="/welcome" method="post">
      <control name="reader_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkchQLEgZSZWFkZXIYgICAgICAgIBIDA" />
      <control name="associate" value="Associate" />
      <response-code value="200" />
    </request>

    <!-- Check that 'gas' is still displayed -->
    <request
      path="/meter_settings?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM">
      <regex
        pattern='&lt;option value="gas-m3" selected="selected"&gt;Gas - m&amp;sup3;&lt;/option&gt;' />
      <response-code value="200" />
    </request>
  </test>
  <test name="Try editing a read">
    <request path="/edit_read" method="post">
      <control name="read_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkcgoLEgRSZWFkGAQM" />
      <control name="read_year" value="2011" />
      <control name="read_month" value="07" />
      <control name="read_day" value="21" />
      <control name="read_hour" value="18" />
      <control name="read_minute" value="40" />
      <control name="value" value="49.0" />
      <response-code value="200" />
    </request>
  </test>
  <test name="Send a customer read">
    <!-- Set header data -->
    <request path="/send_read" method="post">
      <control name="read_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkcgoLEgRSZWFkGAQM" />
      <control name="send_read_to" value="supplier@example.com" />
      <control name="send_read_name" value="Sun Tzu" />
      <control name="send_read_reader_email" value="stzu@example.com" />
      <control name="send_read_address" value="21b Baker Street" />
      <control name="send_read_postcode" value="78560992" />
      <control name="send_read_account" value="89u5u809" />
      <control name="send_read_msn" value="sdjii388" />
      <control name="update" value="Update" />
      <response-code value="200" />
    </request>

    <request path="/send_read" method="post">
      <control name="read_key" value="ahBkZXZ-bWV0ZXJlYWQtaHJkcgoLEgRSZWFkGAQM" />
      <control name="send" value="Send" />
      <response-code value="200" />
    </request>

    <request path="/meter?meter_key=ahBkZXZ-bWV0ZXJlYWQtaHJkchMLEgVNZXRlchiAgICAgICAgFgM">
      <regex pattern="&lt;th&gt;Date of last customer read&lt;/th&gt;"/>
      <response-code value="200" />
    </request>
  </test>
</imprimatur>
