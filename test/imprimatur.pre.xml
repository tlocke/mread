<?xml version="1.0"?>
<!DOCTYPE imprimatur PUBLIC 
    "-//Imprimatur DTD 009//EN"
    "http://imprimatur.sourceforge.net/imprimatur-009.dtd">
<imprimatur port="@@test.port@@" hostname="localhost">
	<test name="Look at home page">
		<request path="/">
			<response-code value="200" />
		</request>
	</test>
	<test name="Try logging in.">
		<!-- Look at log in page -->
		<request path="/sign-in">
			<response-code value="200" />
		</request>
		<!-- Sign in -->
		<request
			path="/_ah/login?email=test%40example.com&amp;action=Login&amp;continue=http%3A%2F%2Flocalhost%3A8081%2Fwelcome"
			follow-redirects="true">
			<response-code value="200" />
		</request>
		<!-- Create account -->
		<request path="/welcome" method="post">
			<response-code value="200" />
			<regex pattern="add a meter"/>
		</request>

		<!-- Add a meter -->
		<request path="/add-meter" method="post">
			<control name="utility_units" value="electricity-kWh" />
			<control name="name" value="House" />
			<control name="time_zone" value="UTC" />
			<control name="email_address" value="None" />
			<control name="confirm_email_address" value="None" />
			<control name="reminder_frequency" value="never" />
			<control name="reminder_start_year" value="2011" />
			<control name="reminder_start_month" value="05" />
			<control name="reminder_start_day" value="01" />
			<control name="reminder_start_hour" value="18" />
			<control name="reminder_start_minute" value="30" />
			<response-code value="200" />
		</request>
	</test>
	<test name="View the meter.">
		<request path="/meter?meter_key=agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM">
			<regex
				pattern='&lt;a href="/_ah/login\?continue=http%3A//localhost%3A8081/&amp;amp;action=Logout"&gt;Sign Out&lt;/a&gt;' />
			<regex pattern='&gt;Me&lt;' />

			<response-code value="200" />
		</request>
	</test>
	<test name="View meter settings.">
		<request path="/meter-settings?meter_key=agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM">
			<regex pattern='&gt;Me&lt;' />
			<regex pattern='&lt;option value="electricity-kWh" selected="selected"&gt;Electricity - kWh&lt;/option&gt;'/>
			<response-code value="200" />
		</request>
	</test>
	<test name="Insert a read.">
		<request path="/meter" method="post">
			<control name="meter_key" value="agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM" />
			<control name="read_year" value="2011" />
			<control name="read_month" value="02" />
			<control name="read_day" value="13" />
			<control name="read_hour" value="17" />
			<control name="read_minute" value="48" />
			<control name="value" value="41" />
			<response-code value="200" />
		</request>
	</test>
	<test name="View the read.">
		<request path="/read?read_key=agxkZXZ-bWV0ZXJlYWRyCgsSBFJlYWQYAww">
			<response-code value="200" />
		</request>
	</test>
	<test name="View the edit-read page.">
		<request path="/edit-read?read_key=agxkZXZ-bWV0ZXJlYWRyCgsSBFJlYWQYAww">
			<response-code value="200" />
			<regex
				pattern='&lt;legend&gt;Delete This Read&lt;/legend&gt;[\r\n]*&lt;input type="hidden" name="read_key" value="agxkZXZ-bWV0ZXJlYWRyCgsSBFJlYWQYAww"' />
		</request>
	</test>
	<test name="Insert a read with a blank value.">
		<request path="/meter" method="post">
			<control name="meter_key" value="agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM" />
			<control name="read_year" value="2011" />
			<control name="read_month" value="02" />
			<control name="read_day" value="13" />
			<control name="read_hour" value="18" />
			<control name="read_minute" value="48" />
			<control name="value" value="" />
			<response-code value="418" />
			<regex pattern="The field &amp;#39;value&amp;#39; is needed\." />
		</request>
	</test>
	<test name="Try inserting a read that's not a number.">
		<request path="/meter" method="post">
			<control name="meter_key" value="agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM" />
			<control name="read_year" value="2011" />
			<control name="read_month" value="02" />
			<control name="read_day" value="13" />
			<control name="read_hour" value="18" />
			<control name="read_minute" value="48" />
			<control name="value" value="sportive bombination" />
			<response-code value="418" />
			<regex pattern="The field &amp;#39;value&amp;#39; doesn&amp;#39;t contain a number\." />
		</request>
	</test>
	<test name="Delete a read.">
		<request path="/edit-read" method="post">
			<control name="read_key" value="agxkZXZ-bWV0ZXJlYWRyCgsSBFJlYWQYAww" />
			<control name="delete" value="Delete" />
			<response-code value="303" />
		</request>
	</test>
	<test name="Insert another read.">
		<request path="/meter" method="post">
			<control name="meter_key" value="agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM" />
			<control name="read_year" value="2011" />
			<control name="read_month" value="02" />
			<control name="read_day" value="15" />
			<control name="read_hour" value="18" />
			<control name="read_minute" value="40" />
			<control name="value" value="49" />
			<response-code value="200" />
		</request>
	</test>
	<test name="Have a look at the upload page.">
		<request path="/upload?meter_key=agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM">
			<regex pattern='"/meter\?meter_key=agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM"' />
			<response-code value="200" />
		</request>
	</test>
	<test name="Have a look at the chart page.">
		<request path="/chart?meter_key=agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM">
			<regex pattern='Sign Out' />
			<response-code value="200" />
		</request>
	</test>
	<test name="Have a look at the reader.">
		<request path="/reader?reader_key=agxkZXZ-bWV0ZXJlYWRyDAsSBlJlYWRlchgBDA">
			<regex pattern='Sign Out' />
			<response-code value="200" />
		</request>
	</test>
	<test name="Propose an OpenId.">
		<request path="/reader-settings" method="post">
			<control name="reader_key" value="agxkZXZ-bWV0ZXJlYWRyDAsSBlJlYWRlchgBDA" />
			<control name="proposed_openid" value="pink@example.com" />
			<control name="propose_openid" value="Propose OpenId" />
			<response-code value="200" />
		</request>
	</test>
	<test name="Try admin stuff.">

		<!-- Sign out -->

		<request
			path="/_ah/login?continue=http%3A//localhost%3A8080/&amp;action=Logout"
			follow-redirects="true">
			<response-code value="200" />
		</request>

		<!-- Sign in as administrator -->
		<request
			path="/_ah/login?email=admin@example.com&amp;admin=True&amp;continue=http://localhost:@@test.port@@/&amp;action=Login"
			follow-redirects="true">
			<response-code value="200" />
		</request>

		<!-- Try sending the reminders -->
		<request path="/cron/reminders">
			<response-code value="200" />
		</request>

		<!-- And Sign out -->
		<request
			path="/_ah/login?continue=http%3A//localhost%3A8080/&amp;action=Logout"
			follow-redirects="true">
			<response-code value="200" />
		</request>
	</test>
	<test name="Try and view the meter without being signed in">
		<request path="/meter?meter_key=agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM">
			<response-code value="401" />
		</request>
	</test>
	<test
		name="Log in, change the meter to public and check it's there on the homepage.">
		<request
			path="/_ah/login?email=test@example.com&amp;continue=http://localhost:@@test.port@@/&amp;action=Login"
			follow-redirects="true">
			<response-code value="200" />
		</request>
		<!-- Also change utility to gas -->
		<request path="/meter-settings" method="post">
			<control name="meter_key" value="agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM" />
			<control name="utility_units" value="gas-m3" />
			<control name="name" value="House" />
			<control name="time_zone" value="UTC" />
			<control name="email_address" value="None" />
			<control name="confirm_email_address" value="None" />
			<control name="reminder_frequency" value="never" />
			<control name="reminder_start_year" value="2011" />
			<control name="reminder_start_month" value="05" />
			<control name="reminder_start_day" value="01" />
			<control name="reminder_start_hour" value="18" />
			<control name="reminder_start_minute" value="30" />
			<control name="is_public" value="True" />
			<response-code value="200" />
		</request>

		<!-- Sign out -->
		<request
			path="/_ah/login?continue=http%3A//localhost%3A8080/&amp;action=Logout"
			follow-redirects="true">
			<response-code value="200" />
		</request>

		<!-- Check the details of the public meter is shown -->
		<request path="/">
			<regex
				pattern='&lt;tr&gt;[\r\n]&lt;td&gt;Me&lt;/td&gt;&lt;td&gt;&lt;a href="/meter\?meter_key=agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM"&gt;House&lt;/a&gt;&lt;/td&gt;&lt;td&gt;Gas&lt;/td&gt;&lt;td&gt;2011-02-15 18:40&lt;/td&gt;&lt;td&gt;&lt;a href="/read\?read_key=agxkZXZ-bWV0ZXJlYWRyCgsSBFJlYWQYBAw"&gt;49.0&lt;/a&gt;&lt;/td&gt;&lt;td&gt;m&lt;sup&gt;3&lt;/sup&gt;&lt;/td&gt;' />
		</request>

		<request path="/read?read_key=agxkZXZ-bWV0ZXJlYWRyCgsSBFJlYWQYBAw">
			<response-code value="200" />
		</request>
	</test>
	<test name="Log in with proposed OpenId">
		<request
			path="/_ah/login?email=pink@example.com&amp;continue=http://localhost:@@test.port@@/welcome&amp;action=Login"
			follow-redirects="true">
			<response-code value="200" />
			<regex
				pattern='&lt;input type="hidden" name="reader_key" value="agxkZXZ-bWV0ZXJlYWRyDAsSBlJlYWRlchgBDA"&gt;' />
		</request>

		<request path="/welcome" method="post">
			<control name="reader_key" value="agxkZXZ-bWV0ZXJlYWRyDAsSBlJlYWRlchgBDA" />
			<control name="associate" value="Associate" />
			<response-code value="200" />
		</request>

		<!-- Check that 'gas' is still displayed -->
		<request path="/meter-settings?meter_key=agxkZXZ-bWV0ZXJlYWRyCwsSBU1ldGVyGAIM">
			<regex
				pattern='&lt;option value="gas-m3" selected="selected"&gt;Gas - m&amp;sup3;&lt;/option&gt;' />
			<response-code value="200" />
		</request>
	</test>
	<test name="Try editing a read">
		<request
			path="/edit-read" method="post">
			<control name="read_key" value="agxkZXZ-bWV0ZXJlYWRyCgsSBFJlYWQYBAw"/>
			<control name="read_year" value="2011"/>
			<control name="read_month" value="07"/>
			<control name="read_day" value="21"/>
			<control name="read_hour" value="18"/>
			<control name="read_minute" value="40"/>
			<control name="value" value="49.0"/>
			<response-code value="200" />
		</request>
	</test>
</imprimatur>